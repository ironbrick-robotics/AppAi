import streamlit as st
from openai import OpenAI
import datetime
import requests

# 1. Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î£ÎµÎ»Î¯Î´Î±Ï‚
st.set_page_config(page_title="ironbrick v9.4 | Educational Portal", page_icon="ğŸ“", layout="wide")

# --- CSS Î“Î™Î‘ Î•Î Î‘Î“Î“Î•Î›ÎœÎ‘Î¤Î™ÎšÎŸ IDE LOOK ---
st.markdown("""
    <style>
    header {visibility: hidden;} footer {visibility: hidden;}
    .stExpander { border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
    .stCodeBlock { border-radius: 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    </style>
    """, unsafe_allow_html=True)

# 2. Î£ÏÎ½Î´ÎµÏƒÎ·
try:
    client = OpenAI(base_url="[https://api.groq.com/openai/v1](https://api.groq.com/openai/v1)", api_key=st.secrets["GROQ_API_KEY"])
    SHEETDB_URL = st.secrets["GSHEET_URL"]
except:
    st.error("âš ï¸ Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚.")

# 3. Tabs
tab_app, tab_info, tab_data = st.tabs(["ğŸš€ Î•ÏÎ³Î±ÏƒÏ„Î®ÏÎ¹Î¿ Î ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï", "ğŸ“– Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚", "ğŸ“‚ Î‘ÏÏ‡ÎµÎ¯Î¿"])

with tab_app:
    if "messages" not in st.session_state:
        st.session_state.messages = []
    if "last_code" not in st.session_state:
        st.session_state.last_code = ""

    col_in, col_out = st.columns([1, 1], gap="large")
    
    with col_in:
        with st.form(key='ide_form', clear_on_submit=True):
            u_id = st.text_input("ID ÎœÎ±Î¸Î·Ï„Î®:", value="Student_01")
            lang_choice = st.selectbox("Î“Î»ÏÏƒÏƒÎ±:", ["MicroPython", "Arduino C"])
            prompt = st.text_area("Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚:", placeholder="Î .Ï‡. ÎšÎ¬Î½Îµ Ï„Î¿ Maqueen Î½Î± ÏƒÏ„ÏÎ¯ÏˆÎµÎ¹ Î´ÎµÎ¾Î¹Î¬ Î±Î½ Î²ÏÎµÎ¹ ÎµÎ¼Ï€ÏŒÎ´Î¹Î¿...", height=150)
            submit = st.form_submit_button("ğŸ”¨ ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î® ÎšÏÎ´Î¹ÎºÎ±")

    with col_out:
        if submit and prompt:
            st.session_state.messages.append({"role": "user", "content": prompt})
            with st.spinner('ğŸ› ï¸ Î£ÏÎ½Î¸ÎµÏƒÎ· Î¿Î´Î·Î³Î¹ÏÎ½...'):
                try:
                    # Î‘Î¥Î£Î¤Î—Î¡ÎŸ Î Î¡Î©Î¤ÎŸÎšÎŸÎ›Î›ÎŸ Î“Î™Î‘ Î‘Î ÎŸÎ¦Î¥Î“Î— AI Î™Î§ÎÎ©Î
                    sys_prompt = (
                        f"Î•Î¯ÏƒÎ±Î¹ Î¿ ÎºÎ±Î¸Î·Î³Î·Ï„Î®Ï‚ ÏÎ¿Î¼Ï€Î¿Ï„Î¹ÎºÎ®Ï‚. Î”ÏÏƒÎµ ÎœÎŸÎÎŸ Ï„Î¿Î½ ÎºÎ±Î¸Î±ÏÏŒ ÎºÏÎ´Î¹ÎºÎ± {lang_choice}. "
                        "ÎœÎ·Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï‚ Markdown blocks (```), Î¼Î·Î½ Î²Î¬Î¶ÎµÎ¹Ï‚ ÏƒÏ‡ÏŒÎ»Î¹Î± 'Generated by AI', "
                        "Î¼Î·Î½ Î´Î¯Î½ÎµÎ¹Ï‚ Ï‡Î±Î¹ÏÎµÏ„Î¹ÏƒÎ¼Î¿ÏÏ‚. Î”ÏÏƒÎµ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï."
                    )
                    
                    response = client.chat.completions.create(
                        model="llama-3.3-70b-versatile",
                        messages=[{"role": "system", "content": sys_prompt}] + st.session_state.messages
                    )
                    
                    # ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î±Ï€ÏŒ Ï„Ï…Ï‡ÏŒÎ½ Markdown Ï€Î¿Ï… Î¾Î­Ï†Ï…Î³Îµ
                    clean_code = response.choices[0].message.content.replace("```python", "").replace("```cpp", "").replace("```", "").strip()
                    st.session_state.last_code = clean_code
                    st.session_state.messages.append({"role": "assistant", "content": clean_code})

                    st.markdown(f"#### âš™ï¸ Î‘ÏÏ‡ÎµÎ¯Î¿: {lang_choice}")
                    st.code(clean_code, language='python' if lang_choice=="MicroPython" else 'cpp')
                    
                    # ÎšÎ¡Î¥Î¦ÎŸ LOGGING
                    requests.post(SHEETDB_URL, json={
                        "data": [{
                            "Timestamp": str(datetime.datetime.now()),
                            "Student_ID": str(u_id),
                            "Language": str(lang_choice),
                            "Prompt": str(prompt),
                            "Answer": str(clean_code).replace('"', "'")
                        }]
                    })
                except:
                    st.error("âš ï¸ Î‘Î´Ï…Î½Î±Î¼Î¯Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ ÎµÎ¾Ï…Ï€Î·ÏÎµÏ„Î·Ï„Î®.")

    # --- Î•ÎšÎ Î‘Î™Î”Î•Î¥Î¤Î™ÎšÎ— Î•Î Î•ÎÎ—Î“Î—Î£Î— ---
    if st.session_state.last_code:
        st.write("")
        with st.expander("ğŸ“š Î‘Î½Î¬Î»Ï…ÏƒÎ· Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ (ÎšÎ±Î¸Î·Î³Î·Ï„Î®Ï‚)"):
            with st.spinner('Î‘Î½Î±Î»ÏÏ‰ Ï„Î· Î»Î¿Î³Î¹ÎºÎ®...'):
                # Prompt Ï€Î¿Ï… ÎµÏ€Î¹Î²Î¬Î»Î»ÎµÎ¹ Î±Î½Î¸ÏÏÏ€Î¹Î½Î¿ ÏÏ†Î¿Ï‚
                explain_msg = [
                    {"role": "system", "content": "Î•Î¯ÏƒÎ±Î¹ Î¿ ÎºÎ±Î¸Î·Î³Î·Ï„Î®Ï‚ Ï„Î¿Ï… Î¼Î±Î¸Î·Ï„Î®. Î•Î¾Î®Î³Î·ÏƒÎµ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ ÎœÎŸÎÎŸ ÏƒÏ„Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬. "
                                                 "ÎœÎ·Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï‚ Ï†ÏÎ¬ÏƒÎµÎ¹Ï‚ ÏŒÏ€Ï‰Ï‚ 'Î©Ï‚ Î¼Î¿Î½Ï„Î­Î»Î¿ Î³Î»ÏÏƒÏƒÎ±Ï‚' Î® 'Î‘Ï…Ï„ÏŒÏ‚ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ ÎºÎ¬Î½ÎµÎ¹'. "
                                                 "ÎœÎ¯Î»Î± Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ ÏƒÏ„Î¿Î½ Î¼Î±Î¸Î·Ï„Î® (Ï€.Ï‡. 'Î•Î´Ï Î¿ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï„Î±Ï‡ÏÏ„Î·Ï„Î±...')."},
                    {"role": "user", "content": f"Î•Î¾Î®Î³Î·ÏƒÎµ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±:\n{st.session_state.last_code}"}
                ]
                exp_res = client.chat.completions.create(model="llama-3.3-70b-versatile", messages=explain_msg)
                st.write(exp_res.choices[0].message.content)

with tab_info:
    st.info("Î•ÏÎµÏ…Î½Î·Ï„Î¹ÎºÎ® Î Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Maqueen v9.4")

with tab_data:
    st.link_button("ğŸ“Š Î ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ Î‘ÏÏ‡ÎµÎ¯Î¿ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½", st.secrets.get("GSHEET_URL_LINK", "#"))
